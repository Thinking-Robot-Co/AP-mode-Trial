<!DOCTYPE html>
<html>
<head>
  <title>Smart Home Dashboard</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      padding: 20px;
    }
    h1 { text-align: center; }
    #device-list {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      justify-content: center;
    }
    .device {
      background: white;
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      width: 250px;
    }
    .device h3 { margin: 0 0 10px; }
    .device button {
      padding: 6px 12px;
      margin-top: 10px;
      margin-right: 8px;
    }
    #add-node-btn {
      display: block;
      margin: 20px auto;
      padding: 10px 20px;
      font-size: 16px;
    }
    /* Modal styling */
    .modal {
      display: none; 
      position: fixed;
      z-index: 100;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.6);
    }
    .modal-content {
      background-color: #fefefe;
      margin: 10% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 90%;
      max-width: 500px;
      border-radius: 8px;
      position: relative;
    }
    .close {
      color: #aaa;
      position: absolute;
      right: 10px;
      top: 10px;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    .close:hover {
      color: black;
    }
    iframe {
      width: 100%;
      height: 300px;
      border: none;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <h1>Smart Home Devices</h1>
  <button id="add-node-btn">+ Add New Node</button>
  <div id="device-list">
    <!-- Devices will appear here -->
  </div>

  <!-- Modal Popup for ESP configuration form -->
  <div id="nodeModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h3>Configure Your Device</h3>
      <!-- The iframe loads the ESP-01 AP mode form page -->
      <iframe id="espFrame" src="http://192.168.4.1"></iframe>
      <!-- You might add extra instructions here if needed -->
      <p>Please configure your device. Once done, the device will exit AP mode and appear on your dashboard.</p>
    </div>
  </div>

  <script type="module">
    // Firebase imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
    import { getDatabase, ref, onValue, update } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-database.js";

    // Use a sanitized version of the email to avoid invalid characters in the path.
    const userEmail = "swdha@gmail,in";  // Replace '.' with ',' (or your preferred safe symbol)
    const userPath = `users/${userEmail}/devices`;

    const firebaseConfig = {
      apiKey: "AIzaSyCaGAZ-7Uk3xe1TyilhwQmEb1wuFkqZoVg",
      authDomain: "smarthomeproject-f5e4a.firebaseapp.com",
      databaseURL: "https://smarthomeproject-f5e4a-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "smarthomeproject-f5e4a",
      storageBucket: "smarthomeproject-f5e4a.appspot.com",
      messagingSenderId: "719061684221",
      appId: "1:719061684221:web:087dbbc3d78704efba9394",
      measurementId: "G-2VWTQ74QPS"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const deviceListDiv = document.getElementById("device-list");

    function renderDevice(deviceId, data) {
      const deviceCard = document.createElement("div");
      deviceCard.className = "device";

      const name = document.createElement("h3");
      name.innerText = data.name || deviceId;

      const toggle = document.createElement("button");
      toggle.innerText = data.switch ? "Turn Off" : "Turn On";
      toggle.onclick = () => {
        const newState = !data.switch;
        update(ref(db, `${userPath}/${deviceId}`), { switch: newState });
      };

      const resetBtn = document.createElement("button");
      resetBtn.innerText = "Reconfigure";
      resetBtn.onclick = () => {
        update(ref(db, `${userPath}/${deviceId}`), { reset: true });
        alert("Reset signal sent to device.");
      };

      deviceCard.appendChild(name);
      deviceCard.appendChild(toggle);
      deviceCard.appendChild(resetBtn);
      deviceListDiv.appendChild(deviceCard);
    }

    // Listen for device updates
    const deviceRef = ref(db, userPath);
    onValue(deviceRef, snapshot => {
      deviceListDiv.innerHTML = "";
      if (snapshot.exists()) {
        const devices = snapshot.val();
        for (const [deviceId, data] of Object.entries(devices)) {
          renderDevice(deviceId, data);
        }
      } else {
        deviceListDiv.innerHTML = "<p>No devices found.</p>";
      }
    });

    // Modal functionality for + Add Node
    const addNodeBtn = document.getElementById("add-node-btn");
    const modal = document.getElementById("nodeModal");
    const closeModal = document.getElementsByClassName("close")[0];

    addNodeBtn.onclick = () => {
      // Instruct the user to connect to the device's AP before showing the form
      modal.style.display = "block";
    };

    closeModal.onclick = () => {
      modal.style.display = "none";
    };

    // Hide modal if user clicks outside of it
    window.onclick = (event) => {
      if (event.target == modal) {
        modal.style.display = "none";
      }
    };
  </script>
</body>
</html>
